# =============================================================================
# YOLO Training Configuration - LightningCLI Format
# =============================================================================
#
# Usage:
#   python -m yolo.cli fit --config yolo/config/experiment/default.yaml
#   python -m yolo.cli fit --config yolo/config/experiment/default.yaml --model.learning_rate=0.001
#   python -m yolo.cli validate --config yolo/config/experiment/default.yaml --ckpt_path=best.ckpt
#
# =============================================================================

# -----------------------------------------------------------------------------
# Trainer Configuration
# -----------------------------------------------------------------------------
trainer:
  max_epochs: 500
  accelerator: auto
  devices: auto
  precision: 16-mixed
  gradient_clip_val: 10.0
  accumulate_grad_batches: 1
  log_every_n_steps: 50
  check_val_every_n_epoch: 1

  # Callbacks
  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        monitor: val/mAP
        mode: max
        save_top_k: 3
        save_last: true
        filename: "epoch={epoch}-mAP={val/mAP:.4f}"
        auto_insert_metric_name: false

    - class_path: lightning.pytorch.callbacks.EarlyStopping
      init_args:
        monitor: val/mAP
        mode: max
        patience: 50
        verbose: true

    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
      init_args:
        logging_interval: step

    - class_path: lightning.pytorch.callbacks.RichProgressBar
      init_args:
        leave: true

  # Logger
  logger:
    - class_path: lightning.pytorch.loggers.TensorBoardLogger
      init_args:
        save_dir: runs/
        name: yolo

# -----------------------------------------------------------------------------
# Model Configuration
# -----------------------------------------------------------------------------
model:
  # Architecture
  model_config: v9-c
  num_classes: 80
  image_size: [640, 640]

  # Optimizer
  learning_rate: 0.01
  momentum: 0.937
  weight_decay: 0.0005

  # Warmup
  warmup_epochs: 3
  warmup_momentum: 0.8
  warmup_bias_lr: 0.1

  # Loss weights
  box_loss_weight: 7.5
  cls_loss_weight: 0.5
  dfl_loss_weight: 1.5

  # Pretrained weights (null for training from scratch)
  weight_path: null

  # NMS settings
  nms_conf_threshold: 0.25
  nms_iou_threshold: 0.65
  nms_max_detections: 300

  # Metrics to log
  log_map: true
  log_map_50: true
  log_map_75: true
  log_map_per_size: true
  log_mar_100: true

# -----------------------------------------------------------------------------
# Data Configuration
# -----------------------------------------------------------------------------
data:
  # Dataset paths
  root: data/coco
  train_images: train2017
  val_images: val2017
  train_ann: annotations/instances_train2017.json
  val_ann: annotations/instances_val2017.json

  # DataLoader
  batch_size: 16
  num_workers: 8
  image_size: [640, 640]
  pin_memory: true

  # Augmentation
  mosaic_prob: 1.0
  mixup_prob: 0.15
  hsv_h: 0.015
  hsv_s: 0.7
  hsv_v: 0.4
  degrees: 0.0
  translate: 0.1
  scale: 0.9
  shear: 0.0
  perspective: 0.0
  flip_lr: 0.5
  flip_ud: 0.0

  # Disable mosaic for last N epochs
  close_mosaic_epochs: 15
