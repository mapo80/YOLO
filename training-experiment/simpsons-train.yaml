# =============================================================================
# Simpsons Character Detection - Training Configuration
# =============================================================================
#
# Dataset: Simpsons Character Detection (Roboflow)
# Model: YOLOv9-Tiny (v9-t)
# Classes: 7 (bart, homer, lisa, maggie, marge, abraham, ned)
#
# Usage:
#   python -m yolo.cli fit --config training-experiment/simpsons-train.yaml
#
# =============================================================================

# -----------------------------------------------------------------------------
# Trainer Configuration
# -----------------------------------------------------------------------------
trainer:
  max_epochs: 100
  accelerator: auto      # Supports: cuda, mps, cpu
  devices: auto          # Auto-detect available devices
  precision: 32          # Use 32 for MPS, 16-mixed for CUDA
  gradient_clip_val: 10.0
  accumulate_grad_batches: 1
  log_every_n_steps: 10
  check_val_every_n_epoch: 1

  # Callbacks
  callbacks:
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        dirpath: training-experiment/checkpoints
        monitor: val/mAP
        mode: max
        save_top_k: 3
        save_last: true
        save_on_train_epoch_end: false
        filename: "simpsons-epoch={epoch:02d}-mAP={val/mAP:.4f}"
        auto_insert_metric_name: false

    - class_path: lightning.pytorch.callbacks.EarlyStopping
      init_args:
        monitor: val/mAP
        mode: max
        patience: 30
        verbose: true
        check_on_train_epoch_end: false  # Check after validation, not training

    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
      init_args:
        logging_interval: step

    - class_path: yolo.training.callbacks.YOLOProgressBar

    - class_path: yolo.training.callbacks.MetricsTableCallback

    # EMA: Exponential Moving Average (improves final accuracy)
    - class_path: yolo.training.callbacks.EMACallback
      init_args:
        decay: 0.9999
        tau: 2000
        enabled: true

  # Logger
  logger:
    - class_path: lightning.pytorch.loggers.TensorBoardLogger
      init_args:
        save_dir: training-experiment/
        name: logs

# -----------------------------------------------------------------------------
# Model Configuration
# -----------------------------------------------------------------------------
model:
  # Architecture - Using Tiny model for faster training
  model_config: v9-t
  num_classes: 7         # Simpsons characters
  image_size: [640, 640]

  # Optimizer
  optimizer: sgd
  learning_rate: 0.01
  momentum: 0.937
  weight_decay: 0.0005
  adamw_betas: [0.9, 0.999]

  # Warmup
  warmup_epochs: 3
  warmup_momentum: 0.8
  warmup_bias_lr: 0.1

  # Loss weights
  box_loss_weight: 7.5
  cls_loss_weight: 0.5
  dfl_loss_weight: 1.5

  # Pretrained weights (null = from scratch, true = auto-download)
  weight_path: true

  # NMS settings
  nms_conf_threshold: 0.25
  nms_iou_threshold: 0.65
  nms_max_detections: 300

  # Metrics to log
  log_map: true
  log_map_50: true
  log_map_75: true
  log_map_95: true
  log_map_per_size: true
  log_mar_100: true
  log_mar_per_size: true

# -----------------------------------------------------------------------------
# Data Configuration
# -----------------------------------------------------------------------------
data:
  # Dataset paths (COCO format)
  root: training-experiment/simpsons-coco-std
  train_images: images/train
  val_images: images/val
  train_ann: annotations/instances_train.json
  val_ann: annotations/instances_val.json

  # DataLoader
  batch_size: 8          # Small batch for small dataset
  num_workers: 4
  image_size: [640, 640]
  pin_memory: true

  # === Multi-Image Augmentation (strong for small dataset) ===
  mosaic_prob: 1.0             # Mosaic always on
  mosaic_9_prob: 0.0           # Use 4-way mosaic
  mixup_prob: 0.3              # Higher mixup for regularization
  mixup_alpha: 32.0
  cutmix_prob: 0.1             # Add cutmix for small dataset

  # === Single-Image Augmentation ===
  hsv_h: 0.015
  hsv_s: 0.7
  hsv_v: 0.4
  degrees: 10.0                # More rotation for cartoon images
  translate: 0.1
  scale: 0.9
  shear: 0.0
  perspective: 0.0
  flip_lr: 0.5
  flip_ud: 0.0

  # === Training Schedule ===
  close_mosaic_epochs: 10
